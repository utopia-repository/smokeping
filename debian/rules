#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

PACKAGE=smokeping
TMP=$(CURDIR)/debian/$(PACKAGE)

include /usr/share/dpatch/dpatch.make

update-docs:
	
	# Regenerate docs from sources.
	# This target is intended to be used to make up 70_regenerate_docs patch, and
	# should be run after applying every patch that is numbered below this, with
	# 'dpatch-edit-patch 70_regenerate_docs 68_typos'
	
	$(MAKE) ref
		
	-rm -f *tmp
	-rm -f doc/*tmp

build: patch-stamp
	$(MAKE) man html txt rename-man
	touch build-stamp

clean: clean-patched unpatch

clean-patched:
	dh_testdir
	dh_testroot
	
	dh_clean

	rm -f build-stamp
	
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	install -d $(TMP)/usr/share/perl5/smokeping
	install -m 644 lib/*pm $(TMP)/usr/share/perl5/smokeping
	rm -f $(TMP)/usr/share/perl5/smokeping/BER.pm
	rm -f $(TMP)/usr/share/perl5/smokeping/SNMP_*

	install -d $(TMP)/usr/share/perl5/smokeping/Smokeping
	install -m 644 lib/Smokeping/*pm $(TMP)/usr/share/perl5/smokeping/Smokeping

	install -d $(TMP)/usr/share/perl5/smokeping/Smokeping/probes
	install -m 644 lib/Smokeping/probes/*pm $(TMP)/usr/share/perl5/smokeping/Smokeping/probes

	install -d $(TMP)/usr/share/perl5/smokeping/Smokeping/matchers
	install -m 644 lib/Smokeping/matchers/*pm $(TMP)/usr/share/perl5/smokeping/Smokeping/matchers

	install -d $(TMP)/usr/share/perl5/smokeping/Config
	install -m 644 lib/Config/*pm $(TMP)/usr/share/perl5/smokeping/Config/

	install -d $(TMP)/usr/sbin/
	install -m 755 bin/smokeping.dist $(TMP)/usr/sbin/smokeping
	install -m 755 bin/tSmoke.dist $(TMP)/usr/sbin/tSmoke

	install -d $(TMP)/etc/smokeping
	install -m 644 etc/basepage.html.dist $(TMP)/etc/smokeping/basepage.html
	install -m 644 etc/config.dist $(TMP)/etc/smokeping/config
	install -m 644 etc/smokemail.dist $(TMP)/etc/smokeping/smokemail
	install -m 644 etc/tmail.dist $(TMP)/etc/smokeping/tmail

	install -d $(TMP)/usr/lib/cgi-bin
	install htdocs/smokeping.cgi.dist $(TMP)/usr/lib/cgi-bin/smokeping.cgi

	install -d $(TMP)/usr/share/doc/$(PACKAGE)/html
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/html/Smokeping
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/html/Smokeping/probes
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/html/Smokeping/matchers
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/txt
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/txt/Smokeping
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/txt/Smokeping/probes
	install -d $(TMP)/usr/share/doc/$(PACKAGE)/txt/Smokeping/matchers

	install -m 644 doc/*.txt $(TMP)/usr/share/doc/$(PACKAGE)/txt
	install -m 644 doc/Smokeping/*.txt $(TMP)/usr/share/doc/$(PACKAGE)/txt/Smokeping
	install -m 644 doc/Smokeping/probes/*.txt $(TMP)/usr/share/doc/$(PACKAGE)/txt/Smokeping/probes
	install -m 644 doc/Smokeping/matchers/*.txt $(TMP)/usr/share/doc/$(PACKAGE)/txt/Smokeping/matchers
	
	install -m 644 doc/*.html $(TMP)/usr/share/doc/$(PACKAGE)/html
	install -m 644 doc/Smokeping/*.html $(TMP)/usr/share/doc/$(PACKAGE)/html/Smokeping
	install -m 644 doc/Smokeping/probes/*.html $(TMP)/usr/share/doc/$(PACKAGE)/html/Smokeping/probes
	install -m 644 doc/Smokeping/matchers/*.html $(TMP)/usr/share/doc/$(PACKAGE)/html/Smokeping/probes
	
	for s in 1 3 5 7;\
	do\
		install -d $(TMP)/usr/share/man/man$$s;\
		for f in `find doc/ -name \*.$$s` ; do install -m 644 $$f $(TMP)/usr/share/man/man$$s; done ; \
	done

binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installdocs

	dh_installdebconf

	# We should start later than ssh (20), so the SSH probe can test against localhost.
	# Just in case, delay initialization even after apache (91).
	dh_installinit -- defaults 92 20

	dh_installman
	dh_installchangelogs CHANGES
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_perl
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep
.PHONY: clean binary-indep binary install build
