#! /bin/sh
# postinst script for smokeping
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#
# quoting from the policy:
#     Any necessary prompting should almost always be confined to the
#     post-installation script, and should be protected with a conditional
#     so that unnecessary prompting doesn't happen if a package's
#     installation fails and the `postinst' is called with `abort-upgrade',
#     `abort-remove' or `abort-deconfigure'.

case "$1" in
    configure)

    if [ ! -z "$2" ]
    then
      if dpkg --compare-versions $2 lt 1.12-2 ;
      then
        echo "Moving rrd data files..."
	find /var/www/smokeping -type f -name '*.rrd' |
	 while read F
	 do
	  G="${F#/var/www/smokeping/}"
	  mkdir -p "/var/lib/smokeping/${G%/*}"
	  mv "$F" "/var/lib/smokeping/$G"
	 done
	cp -f /etc/smokeping/config /etc/smokeping/config.old
	sed -e"s%datadir  = /var/www/smokeping%datadir  = /var/lib/smokeping%" \
		/etc/smokeping/config.old > /etc/smokeping/config
      fi
     
	
      if grep -q /usr/sbin/fping /etc/smokeping/config
      then
        TMPFILE=`mktemp`

        cp -f /etc/smokeping/config $TMPFILE
            
        sed -e"s%/usr/sbin/fping%/usr/bin/fping%" \
		$TMPFILE > /etc/smokeping/config

        rm -f $TMPFILE
      fi

      if dpkg --compare-versions $2 lt 2.0rc5
      then
	if grep -q PROBE_CONF /etc/smokeping/config
	then
	  echo "Upgrading configuration file..."
	  TMPFILE=/etc/smokeping/config.dpkg-save
	  cp -f /etc/smokeping/config /etc/smokeping/config.dpkg-save
	  grep -E -v '^[[:space:]]*\++[[:space:]]*PROBE_CONF' /etc/smokeping/config.dpkg-save > /etc/smokeping/config
	fi
	echo "Testing configuration file..."
	if ! smokeping --check 2>/dev/null # the user will get the same output later with start--stop--daemon
	then
	  echo "NOTE: your configuration file (/etc/smokeping/config) is incompatible"
          echo "      with this Smokeping version and could not be upgraded automatically."
	  echo "      Please read the smokeping_upgrade document."
	fi
      fi
    fi
    
    getent passwd smokeping > /dev/null || \
      adduser --system --group --home /var/lib/smokeping --no-create-home --gecos "SmokePing daemon" smokeping

    # Smokeping.cgi is run as user www-data, so we need it to be able
    # to write in /var/www/smokeping and in /var/lib/smokeping
    chown -R www-data.www-data /var/www/smokeping
    chown -R smokeping.www-data /var/lib/smokeping
    chown -R smokeping.root /var/run/smokeping
    chmod 775 /var/lib/smokeping
    
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


